<div class="sr-wrapper">

  <!-- ‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <header class="dash-header">
    <div class="header-inner">

      <div class="logo-group">
        <svg class="logo-icon" viewBox="0 0 40 40" fill="none">
          <rect width="40" height="40" rx="8" fill="url(#logoGrad3)"/>
          <path d="M12 20L18 26L28 14" stroke="white" stroke-width="3"
                stroke-linecap="round" stroke-linejoin="round"/>
          <defs>
            <linearGradient id="logoGrad3" x1="0" y1="0" x2="40" y2="40">
              <stop offset="0%" stop-color="#2563EB"/>
              <stop offset="100%" stop-color="#1D4ED8"/>
            </linearGradient>
          </defs>
        </svg>
        <div>
          <h1 class="logo-title">Control Panel</h1>
          <p class="logo-subtitle">Subscription & Revenue Control</p>
        </div>
      </div>

      <nav class="main-nav">
        <a *ngFor="let item of navItems"
           [routerLink]="item.route"
           [class.nav-active]="item.active"
           class="nav-link">{{ item.label }}</a>
      </nav>

      <div class="user-area">
        <div class="live-badge">
          <span class="pulse-dot dot-success"></span> Live
        </div>
        <div class="profile-group">
          <div class="avatar">SA</div>
          <div class="profile-info">
            <p class="profile-name">Super Admin</p>
            <p class="profile-role">Administrator</p>
          </div>
        </div>
      </div>

    </div>
  </header>

  <!-- ‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <main class="dash-main">

    <!-- Welcome -->
    <div class="welcome-section">
      <div>
        <h2 class="welcome-title">Subscription & Revenue Control</h2>
        <p class="welcome-sub">Manage plans, billing, revenue analytics ‚Äî {{ today }}</p>
      </div>
      <button class="btn-primary" (click)="openPlanModal()">
        <svg class="icon-xs" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        New Plan
      </button>
    </div>

    <!-- ‚îÄ‚îÄ REVENUE METRICS (6 cards) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="metrics-grid-6">
      <div *ngFor="let m of revenueMetrics" class="metric-card">
        <div class="metric-top">
          <div>
            <p class="metric-label">{{ m.label }}</p>
            <h3 class="metric-value">{{ m.value }}</h3>
          </div>
          <div class="metric-icon" [style.background]="m.iconBg">
            <!-- MRR -->
            <svg *ngIf="m.iconKey === 'mrr'" class="icon-md" [style.color]="m.iconColor"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3
                       2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0
                       1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
            </svg>
            <!-- ARR -->
            <svg *ngIf="m.iconKey === 'arr'" class="icon-md" [style.color]="m.iconColor"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2
                       2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0
                       002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2
                       2 0 01-2 2h-2a2 2 0 01-2-2z"/>
            </svg>
            <!-- Subs -->
            <svg *ngIf="m.iconKey === 'subs'" class="icon-md" [style.color]="m.iconColor"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 20h5v-2a4 4 0 00-5-3.87M9 20H4v-2a4 4 0 015-3.87m6
                       0a4 4 0 10-6 0m6 0H9"/>
            </svg>
            <!-- Churn -->
            <svg *ngIf="m.iconKey === 'churn'" class="icon-md" [style.color]="m.iconColor"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/>
            </svg>
            <!-- ARPU -->
            <svg *ngIf="m.iconKey === 'arpu'" class="icon-md" [style.color]="m.iconColor"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            <!-- Failures -->
            <svg *ngIf="m.iconKey === 'failures'" class="icon-md" [style.color]="m.iconColor"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667
                       1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34
                       16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
          </div>
        </div>
        <div class="metric-trend">
          <span *ngIf="m.trend === 'up'" class="trend-up">
            <svg class="icon-xs" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                    d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1
                       1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707
                       9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
            {{ m.trendValue }}
          </span>
          <span *ngIf="m.trend === 'down'" class="trend-down">
            <svg class="icon-xs" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                    d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414
                       0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1
                       1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            {{ m.trendValue }}
          </span>
          <span class="trend-label">{{ m.trendLabel }}</span>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ EXPIRY ALERTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="expiry-banner card-elevated">
      <div class="expiry-banner-hdr">
        <svg class="icon-sm color-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <h4 class="expiry-title">Subscription Expiry Alerts</h4>
        <span class="expiry-count">{{ expiryAlerts.length }} expiring soon</span>
      </div>
      <div class="expiry-list">
        <div *ngFor="let e of expiryAlerts" class="expiry-item" [ngClass]="getExpiryClass(e.expiresIn)">
          <div class="expiry-left">
            <span class="expiry-tenant">{{ e.tenantName }}</span>
            <span class="plan-badge" [ngClass]="getPlanBadgeClass(e.plan)">{{ e.plan }}</span>
          </div>
          <div class="expiry-right">
            <span class="expiry-days"
                  [class.expiry-days-critical]="e.expiresIn <= 3"
                  [class.expiry-days-warning]="e.expiresIn > 3 && e.expiresIn <= 7">
              {{ e.expiresIn }}d left
            </span>
            <span class="expiry-amt">{{ e.renewalAmt }}</span>
            <button class="btn-remind">Remind</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ TAB NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="tab-nav card-elevated">
      <button *ngFor="let tab of tabs"
              class="tab-btn"
              [class.tab-active]="activeTab === tab.key"
              (click)="setTab(tab.key)">
        {{ tab.label }}
      </button>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: PLANS                                   -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div *ngIf="activeTab === 'plans'" class="tab-content">
      <div class="plans-grid">
        <div *ngFor="let plan of plans" class="plan-card"
             [class.plan-paused]="plan.status === 'paused'"
             [style.border-top]="'3px solid ' + plan.color">

          <!-- Plan Header -->
          <div class="plan-card-hdr">
            <div>
              <h3 class="plan-name" [style.color]="plan.color">{{ plan.name }}</h3>
              <p class="plan-tagline">{{ plan.tagline }}</p>
            </div>
            <div class="plan-status-area">
              <span class="plan-status-badge"
                    [class.psb-active]="plan.status === 'active'"
                    [class.psb-paused]="plan.status === 'paused'">
                {{ plan.status | titlecase }}
              </span>
            </div>
          </div>

          <!-- Price -->
          <div class="plan-price-row">
            <span class="plan-price">{{ plan.currency }}{{ plan.price | number }}</span>
            <span class="plan-cycle">/ {{ plan.billingCycle }}</span>
          </div>
          <p class="plan-mrr">MRR: {{ formatMRR(plan.mrr) }} ¬∑ {{ plan.activeSubscribers }} subscribers</p>

          <!-- Limits -->
          <div class="plan-limits">
            <span class="limit-chip">üë• {{ plan.maxStaff }} staff</span>
            <span class="limit-chip">üì¶ {{ plan.maxOrders | number }} orders</span>
            <span class="limit-chip">üíæ {{ plan.storageGB }}GB</span>
            <span class="limit-chip">üéÅ {{ plan.trialDays }}d trial</span>
            <span *ngIf="plan.usageBilling" class="limit-chip chip-usage">‚ö° Usage billing</span>
          </div>

          <!-- Features -->
          <ul class="plan-features">
            <li *ngFor="let f of plan.features.slice(0, 4)" class="plan-feature-item">
              <svg class="icon-xs color-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              {{ f }}
            </li>
            <li *ngIf="plan.features.length > 4" class="plan-feature-more">
              +{{ plan.features.length - 4 }} more features
            </li>
          </ul>

          <!-- Billing Cycle Toggle -->
          <div class="billing-cycle-row">
            <span class="bc-label">Billing:</span>
            <div class="bc-toggles">
              <button *ngFor="let cycle of ['Monthly','Quarterly','Yearly']"
                      class="bc-btn"
                      [class.bc-active]="plan.billingCycle === cycle"
                      (click)="changeBillingCycle(plan, $any(cycle))">
                {{ cycle }}
              </button>
            </div>
          </div>

          <!-- Actions -->
          <div class="plan-actions">
            <button class="pa-btn pa-price" (click)="openPriceEdit(plan)">
              Edit Price
            </button>
            <button class="pa-btn"
                    [class.pa-pause]="plan.status === 'active'"
                    [class.pa-resume]="plan.status === 'paused'"
                    (click)="togglePlanStatus(plan)">
              {{ plan.status === 'active' ? 'Pause' : 'Resume' }}
            </button>
            <button class="pa-btn pa-edit" (click)="openPlanModal(plan)">
              Edit
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: REVENUE ANALYTICS                       -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div *ngIf="activeTab === 'revenue'" class="tab-content">
      <div class="analytics-layout">

        <!-- MRR Trend Chart -->
        <div class="card-elevated chart-card">
          <h4 class="chart-title">MRR Trend (Last 6 Months)</h4>
          <div class="bar-chart">
            <div *ngFor="let m of mrrTrend" class="bar-col">
              <div class="bar-value">{{ formatMRR(m.value) }}</div>
              <div class="bar-wrap">
                <div class="bar-fill" [style.height.%]="mrrBarHeight(m.value)"></div>
              </div>
              <div class="bar-label">{{ m.month }}</div>
            </div>
          </div>
        </div>

        <!-- Plan Distribution -->
        <div class="card-elevated chart-card">
          <h4 class="chart-title">Plan Distribution</h4>
          <div class="dist-list">
            <div *ngFor="let p of planDistribution" class="dist-row">
              <div class="dist-info">
                <span class="dist-name">{{ p.name }}</span>
                <span class="dist-count">{{ p.count }} subscribers</span>
              </div>
              <div class="dist-bar-bg">
                <div class="dist-bar-fill"
                     [style.width.%]="planBarWidth(p.count)"
                     [style.background]="p.color">
                </div>
              </div>
              <span class="dist-pct">{{ planBarWidth(p.count) }}%</span>
            </div>
          </div>

          <!-- Summary Table -->
          <div class="rev-summary">
            <div class="rev-row rev-header">
              <span>Plan</span><span>Subscribers</span><span>MRR</span>
            </div>
            <div *ngFor="let plan of plans" class="rev-row">
              <span class="plan-badge" [ngClass]="getPlanBadgeClass(plan.name)">{{ plan.name }}</span>
              <span>{{ plan.activeSubscribers }}</span>
              <span class="rev-mrr">{{ formatMRR(plan.mrr) }}</span>
            </div>
            <div class="rev-row rev-total">
              <span>Total</span>
              <span>{{ totalSubscribers }}</span>
              <span>{{ formatMRR(revenueMetrics[0].rawValue) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: PROMO CODES                             -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div *ngIf="activeTab === 'promos'" class="tab-content">
      <div class="card-elevated">
        <div class="section-hdr">
          <h4 class="section-title">Promo Codes</h4>
          <button class="btn-primary btn-sm" (click)="openPromoModal()">+ New Code</button>
        </div>
        <div class="table-scroll">
          <table class="sr-table">
            <thead>
              <tr>
                <th>Code</th><th>Type</th><th>Value</th>
                <th>Usage</th><th>Expires</th><th>Plans</th>
                <th>Status</th><th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let promo of promoCodes">
                <td><span class="promo-code-tag">{{ promo.code }}</span></td>
                <td>{{ promo.type | titlecase }}</td>
                <td>
                  <strong>
                    {{ promo.type === 'percent' ? promo.value + '%' : '‚Çπ' + promo.value }}
                  </strong>
                </td>
                <td>
                  <div class="usage-bar-mini">
                    <div class="ubm-fill"
                         [style.width.%]="(promo.usedCount / promo.maxUses) * 100">
                    </div>
                  </div>
                  <span class="usage-txt">{{ promo.usedCount }} / {{ promo.maxUses }}</span>
                </td>
                <td class="td-mono">{{ promo.expiryDate }}</td>
                <td>
                  <span *ngFor="let p of promo.applicablePlans"
                        class="plan-badge" [ngClass]="getPlanBadgeClass(p)">{{ p }}</span>
                </td>
                <td>
                  <span class="promo-status" [ngClass]="getPromoStatusClass(promo.status)">
                    {{ promo.status | titlecase }}
                  </span>
                </td>
                <td>
                  <button class="tbl-action-btn btn-deactivate"
                          *ngIf="promo.status === 'active'"
                          (click)="deactivatePromo(promo)">
                    Deactivate
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: PAYMENT LOGS                            -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div *ngIf="activeTab === 'payments'" class="tab-content">
      <div class="card-elevated">
        <div class="section-hdr">
          <h4 class="section-title">Payment & Failure Logs</h4>
          <div class="log-stats">
            <span class="ls-success">
              ‚úì {{ paymentLogs | paymentFilter:'success' }} success
            </span>
            <span class="ls-failed">
              ‚úó {{ paymentLogs | paymentFilter:'failed' }} failed
            </span>
          </div>
        </div>
        <div class="table-scroll">
          <table class="sr-table">
            <thead>
              <tr>
                <th>Invoice</th><th>Tenant</th><th>Plan</th>
                <th>Amount</th><th>Status</th><th>Date</th>
                <th>Failure Reason</th><th>Invoice</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let log of paymentLogs"
                  [class.row-failed]="log.status === 'failed'"
                  [class.row-pending]="log.status === 'pending'">
                <td><span class="invoice-id">{{ log.invoiceId }}</span></td>
                <td>
                  <div>
                    <p class="log-tenant">{{ log.tenantName }}</p>
                    <p class="log-restaurant">{{ log.restaurantName }}</p>
                  </div>
                </td>
                <td><span class="plan-badge" [ngClass]="getPlanBadgeClass(log.plan)">{{ log.plan }}</span></td>
                <td><strong>{{ log.amount }}</strong></td>
                <td>
                  <span class="payment-status" [ngClass]="getPaymentStatusClass(log.status)">
                    {{ log.status | titlecase }}
                  </span>
                </td>
                <td class="td-mono">{{ log.date }}</td>
                <td class="td-reason">
                  <span *ngIf="log.failureReason" class="failure-reason">
                    {{ log.failureReason }}
                  </span>
                  <span *ngIf="!log.failureReason" class="no-issue">‚Äî</span>
                </td>
                <td>
                  <button class="tbl-action-btn btn-invoice" (click)="openInvoiceModal(log)">
                    View
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: REFUNDS                                 -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div *ngIf="activeTab === 'refunds'" class="tab-content">
      <div class="card-elevated">
        <div class="section-hdr">
          <h4 class="section-title">Refund Management</h4>
          <span class="pending-badge">
            {{ refundRequests | refundFilter:'pending' }} pending
          </span>
        </div>
        <div class="table-scroll">
          <table class="sr-table">
            <thead>
              <tr>
                <th>Invoice</th><th>Tenant</th><th>Plan</th>
                <th>Amount</th><th>Reason</th><th>Requested</th>
                <th>Status</th><th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of refundRequests">
                <td><span class="invoice-id">{{ r.invoiceId }}</span></td>
                <td><strong>{{ r.tenantName }}</strong></td>
                <td><span class="plan-badge" [ngClass]="getPlanBadgeClass(r.plan)">{{ r.plan }}</span></td>
                <td><strong>{{ r.amount }}</strong></td>
                <td class="td-reason">{{ r.reason }}</td>
                <td class="td-mono">{{ r.requestDate }}</td>
                <td>
                  <span class="refund-status" [ngClass]="getRefundStatusClass(r.status)">
                    {{ r.status | titlecase }}
                  </span>
                </td>
                <td>
                  <button *ngIf="r.status === 'pending'"
                          class="tbl-action-btn btn-approve"
                          (click)="openRefundModal(r)">
                    Review
                  </button>
                  <span *ngIf="r.status !== 'pending'" class="td-resolved">Resolved</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: GST / TAX                               -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div *ngIf="activeTab === 'tax'" class="tab-content">
      <div class="card-elevated">
        <div class="section-hdr">
          <h4 class="section-title">GST / Tax Configuration</h4>
          <button class="btn-primary btn-sm" (click)="openTaxModal()">+ Add Rule</button>
        </div>
        <div class="tax-grid">
          <div *ngFor="let tax of taxConfigs" class="tax-card"
               [class.tax-inactive]="!tax.active">
            <div class="tax-hdr">
              <div>
                <h4 class="tax-region">{{ tax.region }}</h4>
                <p class="tax-name">{{ tax.taxName }}</p>
              </div>
              <div class="tax-toggle-area">
                <button class="toggle-btn" [class.toggle-on]="tax.active"
                        (click)="toggleTax(tax)">
                  {{ tax.active ? 'Active' : 'Disabled' }}
                </button>
              </div>
            </div>
            <div class="tax-rate-display">
              <span class="tax-rate">{{ tax.rate }}%</span>
              <span class="tax-rate-label">Tax Rate</span>
            </div>
            <div class="tax-reg">
              <span class="tax-reg-label">Registration No.</span>
              <span class="tax-reg-val">{{ tax.registrationNo }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: REGIONAL PRICING                        -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div *ngIf="activeTab === 'regional'" class="tab-content">
      <div class="card-elevated">
        <div class="section-hdr">
          <h4 class="section-title">Regional Pricing</h4>
          <p class="section-sub">Configure region-specific pricing for each plan</p>
        </div>
        <div class="table-scroll">
          <table class="sr-table regional-table">
            <thead>
              <tr>
                <th>Plan</th>
                <th *ngFor="let region of ['IN üáÆüá≥','US üá∫üá∏','EU üá™üá∫','SEA üåè']">{{ region }}</th>
                <th>Usage Billing</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let plan of plans">
                <td>
                  <span class="plan-badge" [ngClass]="getPlanBadgeClass(plan.name)">{{ plan.name }}</span>
                </td>
                <td *ngFor="let region of ['IN','US','EU','SEA']">
                  <ng-container *ngFor="let rp of plan.regionalPricing">
                    <span *ngIf="rp.region === region" class="regional-price">
                      {{ rp.currency }}{{ rp.price | number }}
                    </span>
                  </ng-container>
                  <span *ngIf="!hasRegion(plan, region)" class="no-price">‚Äî</span>
                </td>
                <td>
                  <span class="usage-badge" [class.usage-on]="plan.usageBilling">
                    {{ plan.usageBilling ? 'Enabled' : 'Disabled' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Usage Billing Detail -->
        <div class="usage-billing-info">
          <h5 class="ubi-title">Usage-based Billing Rules</h5>
          <div class="ubi-grid">
            <div class="ubi-card">
              <p class="ubi-metric">Orders</p>
              <p class="ubi-rate">‚Çπ0.50 / order after 10,000</p>
            </div>
            <div class="ubi-card">
              <p class="ubi-metric">API Calls</p>
              <p class="ubi-rate">‚Çπ0.01 / 100 calls after limit</p>
            </div>
            <div class="ubi-card">
              <p class="ubi-metric">Storage</p>
              <p class="ubi-rate">‚Çπ10 / GB after plan limit</p>
            </div>
            <div class="ubi-card">
              <p class="ubi-metric">Staff Seats</p>
              <p class="ubi-rate">‚Çπ50 / seat after plan max</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main><!-- end main -->


  <!-- ‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="modal-overlay"
       *ngIf="showPlanModal || showPromoModal || showTaxModal || showRefundModal || showInvoiceModal || showPriceEditModal"
       (click)="closeAllModals()">
  </div>

  <!-- Price Edit Modal -->
  <div class="modal-box" *ngIf="showPriceEditModal && selectedPlan">
    <div class="modal-hdr">
      <h3>Edit Price ‚Äî {{ selectedPlan.name }}</h3>
      <button class="close-btn" (click)="closeAllModals()">‚úï</button>
    </div>
    <div class="modal-body">
      <p class="modal-desc">
        Current price: <strong>{{ selectedPlan.currency }}{{ selectedPlan.price | number }}</strong>
        / {{ selectedPlan.billingCycle }}
      </p>
      <div class="form-group">
        <label class="form-label">New Price ({{ selectedPlan.currency }})</label>
        <div class="price-input-row">
          <button class="price-adj-btn" (click)="editingPrice = editingPrice - 50">‚àí50</button>
          <input type="number" class="form-input price-input" [(ngModel)]="editingPrice" min="0"/>
          <button class="price-adj-btn" (click)="editingPrice = editingPrice + 50">+50</button>
        </div>
      </div>
      <div class="warn-box">
        This will affect all <strong>{{ selectedPlan.activeSubscribers }}</strong> active subscribers
        on their next billing cycle.
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" (click)="closeAllModals()">Cancel</button>
      <button class="btn-primary" (click)="confirmPriceChange()">Save Price</button>
    </div>
  </div>

  <!-- New Plan Modal -->
  <div class="modal-box modal-wide" *ngIf="showPlanModal && !selectedPlan">
    <div class="modal-hdr">
      <h3>Create New Plan</h3>
      <button class="close-btn" (click)="closePlanModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-grid-2">
        <div class="form-group">
          <label class="form-label">Plan Name</label>
          <input type="text" class="form-input" [(ngModel)]="newPlan.name" placeholder="e.g. Enterprise"/>
        </div>
        <div class="form-group">
          <label class="form-label">Tagline</label>
          <input type="text" class="form-input" [(ngModel)]="newPlan.tagline" placeholder="Short description"/>
        </div>
        <div class="form-group">
          <label class="form-label">Price (‚Çπ)</label>
          <input type="number" class="form-input" [(ngModel)]="newPlan.price" min="0"/>
        </div>
        <div class="form-group">
          <label class="form-label">Billing Cycle</label>
          <select class="form-select" [(ngModel)]="newPlan.billingCycle">
            <option>Monthly</option><option>Quarterly</option><option>Yearly</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Max Staff</label>
          <input type="number" class="form-input" [(ngModel)]="newPlan.maxStaff" min="1"/>
        </div>
        <div class="form-group">
          <label class="form-label">Max Orders / Month</label>
          <input type="number" class="form-input" [(ngModel)]="newPlan.maxOrders" min="1"/>
        </div>
        <div class="form-group">
          <label class="form-label">Storage (GB)</label>
          <input type="number" class="form-input" [(ngModel)]="newPlan.storageGB" min="1"/>
        </div>
        <div class="form-group">
          <label class="form-label">Trial Days</label>
          <input type="number" class="form-input" [(ngModel)]="newPlan.trialDays" min="0"/>
        </div>
      </div>
      <div class="form-group mt-12">
        <label class="form-label">Features (comma separated)</label>
        <textarea class="form-textarea" [(ngModel)]="newPlan.features" rows="3"
                  placeholder="POS, Menu Management, Reports‚Ä¶"></textarea>
      </div>
      <div class="form-check">
        <input type="checkbox" id="usageBilling" [(ngModel)]="newPlan.usageBilling"/>
        <label for="usageBilling" class="form-check-label">Enable Usage-based Billing</label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" (click)="closePlanModal()">Cancel</button>
      <button class="btn-primary" (click)="closePlanModal()">Create Plan</button>
    </div>
  </div>

  <!-- New Promo Code Modal -->
  <div class="modal-box" *ngIf="showPromoModal">
    <div class="modal-hdr">
      <h3>Create Promo Code</h3>
      <button class="close-btn" (click)="closePromoModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Promo Code</label>
        <input type="text" class="form-input text-upper" [(ngModel)]="newPromo.code"
               placeholder="e.g. SAVE30"/>
      </div>
      <div class="form-grid-2">
        <div class="form-group">
          <label class="form-label">Discount Type</label>
          <select class="form-select" [(ngModel)]="newPromo.type">
            <option value="percent">Percentage (%)</option>
            <option value="flat">Flat Amount (‚Çπ)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Value</label>
          <input type="number" class="form-input" [(ngModel)]="newPromo.value" min="1"/>
        </div>
        <div class="form-group">
          <label class="form-label">Max Uses</label>
          <input type="number" class="form-input" [(ngModel)]="newPromo.maxUses" min="1"/>
        </div>
        <div class="form-group">
          <label class="form-label">Expiry Date</label>
          <input type="date" class="form-input" [(ngModel)]="newPromo.expiryDate"/>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Applicable Plan</label>
        <select class="form-select" [(ngModel)]="newPromo.applicablePlans">
          <option>Basic</option><option>Basic+</option>
          <option>Premium</option><option>Ultra</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" (click)="closePromoModal()">Cancel</button>
      <button class="btn-primary" (click)="addPromoCode()">Create</button>
    </div>
  </div>

  <!-- Invoice View Modal -->
  <div class="modal-box" *ngIf="showInvoiceModal && selectedLog">
    <div class="modal-hdr">
      <h3>Invoice ‚Äî {{ selectedLog.invoiceId }}</h3>
      <button class="close-btn" (click)="closeInvoiceModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="invoice-preview">
        <div class="inv-header">
          <div class="inv-logo">
            <svg viewBox="0 0 40 40" fill="none" class="inv-logo-svg">
              <rect width="40" height="40" rx="6" fill="#2563EB"/>
              <path d="M12 20L18 26L28 14" stroke="white" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span class="inv-company">Control Panel Inc.</span>
          </div>
          <div class="inv-status-area">
            <span class="payment-status" [ngClass]="getPaymentStatusClass(selectedLog.status)">
              {{ selectedLog.status | titlecase }}
            </span>
          </div>
        </div>
        <div class="inv-details">
          <div class="inv-row"><span>Invoice ID</span><strong>{{ selectedLog.invoiceId }}</strong></div>
          <div class="inv-row"><span>Tenant</span><strong>{{ selectedLog.tenantName }}</strong></div>
          <div class="inv-row"><span>Restaurant</span><strong>{{ selectedLog.restaurantName }}</strong></div>
          <div class="inv-row"><span>Plan</span>
            <span class="plan-badge" [ngClass]="getPlanBadgeClass(selectedLog.plan)">{{ selectedLog.plan }}</span>
          </div>
          <div class="inv-row"><span>Date</span><strong>{{ selectedLog.date }}</strong></div>
          <div class="inv-divider"></div>
          <div class="inv-row inv-total">
            <span>Amount</span>
            <strong class="inv-amount">{{ selectedLog.amount }}</strong>
          </div>
          <div class="inv-row" *ngIf="selectedLog.failureReason">
            <span>Failure Reason</span>
            <strong class="color-error">{{ selectedLog.failureReason }}</strong>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" (click)="closeInvoiceModal()">Close</button>
      <button class="btn-primary" (click)="downloadInvoice()">
        <svg class="icon-xs" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
        </svg>
        Download
      </button>
    </div>
  </div>

  <!-- Refund Review Modal -->
  <div class="modal-box" *ngIf="showRefundModal && selectedRefund">
    <div class="modal-hdr">
      <h3>Review Refund Request</h3>
      <button class="close-btn" (click)="closeAllModals()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="info-rows">
        <div class="info-row"><span>Tenant</span><strong>{{ selectedRefund.tenantName }}</strong></div>
        <div class="info-row"><span>Plan</span>
          <span class="plan-badge" [ngClass]="getPlanBadgeClass(selectedRefund.plan)">{{ selectedRefund.plan }}</span>
        </div>
        <div class="info-row"><span>Amount</span><strong>{{ selectedRefund.amount }}</strong></div>
        <div class="info-row"><span>Invoice</span><strong>{{ selectedRefund.invoiceId }}</strong></div>
        <div class="info-row"><span>Requested</span><strong>{{ selectedRefund.requestDate }}</strong></div>
      </div>
      <div class="refund-reason-box">
        <p class="rfb-label">Reason</p>
        <p class="rfb-text">{{ selectedRefund.reason }}</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" (click)="closeAllModals()">Cancel</button>
      <button class="btn-danger" (click)="rejectRefund()">Reject</button>
      <button class="btn-primary" (click)="approveRefund()">Approve Refund</button>
    </div>
  </div>

</div><!-- end sr-wrapper -->
