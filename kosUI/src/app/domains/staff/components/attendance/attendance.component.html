<div class="attendance-wrapper" [class.loading-state]="loading" [attr.aria-busy]="loading">

  <!-- Error Banner -->
  <div class="error-banner" *ngIf="errorMessage" role="alert">
    âš ï¸ {{ errorMessage }}
  </div>

  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="attendance-header">
    <div class="header-left">
      <h2 class="page-title">ğŸ• Attendance</h2>
      <span class="view-badge" [class.employee-badge]="viewMode === 'employee'">
        {{ viewMode === 'manager' ? 'Manager View' : 'My Attendance' }}
      </span>
    </div>

    <div class="header-actions">

      <!-- Back to employee view â€” only shown when in manager mode -->
      <button class="btn-toggle btn-back"
        *ngIf="viewMode === 'manager'"
        (click)="switchToEmployee()">
        ğŸ‘¤ My Attendance
      </button>

      <!-- Switch to manager â€” only shown if role permits AND currently in employee view -->
      <button class="btn-toggle btn-manager"
        *ngIf="hasManagerAccess && viewMode === 'employee'"
        (click)="switchToManager()">
        ğŸ”‘ Manager View
      </button>

      <input
        type="date"
        class="date-picker"
        [value]="selectedDateIso"
        (change)="onDateChange($any($event.target).value)"
        aria-label="Select date"
      />
    </div>
  </div>

  <!-- â”€â”€ KPI Strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="kpi-strip" *ngIf="kpi && viewMode === 'manager'">
    <div class="kpi-card kpi-present">
      <span class="kpi-icon">âœ…</span>
      <div class="kpi-body">
        <strong>{{ kpi.present }}</strong>
        <small>Present</small>
      </div>
    </div>
    <div class="kpi-card kpi-absent">
      <span class="kpi-icon">âŒ</span>
      <div class="kpi-body">
        <strong>{{ kpi.absent }}</strong>
        <small>Absent</small>
      </div>
    </div>
    <div class="kpi-card kpi-late">
      <span class="kpi-icon">â°</span>
      <div class="kpi-body">
        <strong>{{ kpi.late }}</strong>
        <small>Late</small>
      </div>
    </div>
    <div class="kpi-card kpi-leave">
      <span class="kpi-icon">ğŸ–ï¸</span>
      <div class="kpi-body">
        <strong>{{ kpi.onLeave }}</strong>
        <small>On Leave</small>
      </div>
    </div>
    <div class="kpi-card kpi-total">
      <span class="kpi-icon">ğŸ‘¥</span>
      <div class="kpi-body">
        <strong>{{ records.length }}</strong>
        <small>Total Staff</small>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Employee Self-View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="self-view" *ngIf="viewMode === 'employee'">

    <div class="self-card" *ngIf="myRecord; else noSelfRecord">
      <div class="self-avatar">{{ myRecord.staffName.charAt(0) }}</div>

      <div class="self-info">
        <h3>{{ myRecord.staffName }}</h3>
        <p class="self-sub">{{ myRecord.staffId }}</p>
      </div>

      <div class="self-status">
        <span class="status-badge"
          [style.background]="getAttendanceStatusColor(myRecord.status)">
          {{ getStatusLabel(myRecord.status) }}
        </span>
      </div>

      <div class="self-times">
        <div class="time-block">
          <small>Clock In</small>
          <strong>{{ myRecord.clockIn ?? 'â€”' }}</strong>
        </div>
        <div class="time-block">
          <small>Clock Out</small>
          <strong>{{ myRecord.clockOut ?? 'â€”' }}</strong>
        </div>
        <div class="time-block">
          <small>Hours</small>
          <strong>{{ myRecord.totalHours | number:'1.1-2' }}h</strong>
        </div>
      </div>

      <button class="btn-clockout"
        *ngIf="myRecord.clockIn && !myRecord.clockOut"
        (click)="handleClockOut(myRecord.staffId)">
        ğŸ”´ Clock Out
      </button>
    </div>

    <ng-template #noSelfRecord>
      <div class="empty-state">
        <div class="empty-icon">ğŸ“‹</div>
        <p>No attendance record found for today.</p>
      </div>
    </ng-template>

    <!-- Monthly Calendar â€” Employee -->
    <div class="calendar-section">
      <h3>{{ calendarMonthLabel }}</h3>
      <div class="calendar-grid">
        <div class="cal-day-label"
          *ngFor="let d of ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']">
          {{ d }}
        </div>
        <div class="cal-offset"
          aria-hidden="true"
          *ngFor="let _ of getOffsetArray()">
        </div>
        <div class="cal-day"
          *ngFor="let day of calendarDays"
          [class.cal-today]="day.date.toDateString() === selectedDate.toDateString()"
          [style.border-color]="day.status ? getAttendanceStatusColor(day.status) : '#e2e8f0'"
          [title]="day.status ? getStatusLabel(day.status) : ''">
          <span class="cal-date">{{ day.date.getDate() }}</span>
          <span class="cal-dot"
            *ngIf="day.status"
            [style.background]="getAttendanceStatusColor(day.status)">
          </span>
        </div>
      </div>
      <div class="calendar-legend">
        <span *ngFor="let s of allStatusValues" class="legend-item">
          <span class="legend-dot" [style.background]="getAttendanceStatusColor(s)"></span>
          {{ getStatusLabel(s) }}
        </span>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Manager Table View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="manager-section" *ngIf="viewMode === 'manager'">

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="filter-tabs">
        <button
          *ngFor="let s of statusOptions"
          class="filter-tab"
          [class.active]="statusFilter === s"
          (click)="statusFilter = s">
          {{ getStatusLabel(s) }}
          <span class="tab-count">{{ getCountByStatus(s) }}</span>
        </button>
      </div>
      <div class="search-box">
        <span class="search-icon">ğŸ”</span>
        <input
          type="text"
          placeholder="Search staff..."
          [(ngModel)]="searchQuery"
          aria-label="Search staff"
        />
      </div>
      <button class="btn-mark-all" (click)="openMarkModal()">
        âœï¸ Mark Attendance
      </button>
    </div>

    <!-- Loading Skeleton -->
    <div class="skeleton-rows" *ngIf="loading" aria-label="Loading attendance...">
      <div class="skeleton-row" *ngFor="let _ of [1,2,3,4,5]">
        <div class="skel skel-avatar"></div>
        <div class="skel skel-name"></div>
        <div class="skel skel-status"></div>
        <div class="skel skel-time"></div>
        <div class="skel skel-time"></div>
        <div class="skel skel-btn"></div>
      </div>
    </div>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="isEmpty()">
      <div class="empty-icon">ğŸ“‹</div>
      <p>No attendance records found for the selected date.</p>
    </div>

    <!-- Attendance Table -->
    <div class="table-wrapper" *ngIf="!loading && filteredRecords.length > 0">
      <table class="attendance-table" aria-label="Attendance records">
        <thead>
          <tr>
            <th>Staff</th>
            <th>Status</th>
            <th>Clock In</th>
            <th>Clock Out</th>
            <th>Hours</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let rec of filteredRecords; trackBy: trackByRecordId"
              class="table-row"
              (click)="openDetailModal(rec)">
            <td class="staff-cell">
              <div class="staff-avatar">{{ rec.staffName.charAt(0) }}</div>
              <div class="staff-meta">
                <span class="staff-name">{{ rec.staffName }}</span>
                <span class="staff-id">{{ rec.staffId }}</span>
              </div>
            </td>
            <td>
              <span class="status-badge"
                [style.background]="getAttendanceStatusColor(rec.status)">
                {{ getStatusLabel(rec.status) }}
              </span>
            </td>
            <td class="time-cell">{{ rec.clockIn ?? 'â€”' }}</td>
            <td class="time-cell">{{ rec.clockOut ?? 'â€”' }}</td>
            <td class="hours-cell">
              <span *ngIf="rec.totalHours > 0">{{ rec.totalHours | number:'1.1-2' }}h</span>
              <span *ngIf="rec.totalHours === 0" class="no-hours">â€”</span>
            </td>
            <td class="notes-cell">{{ rec.notes || 'â€”' }}</td>
            <td class="actions-cell" (click)="$event.stopPropagation()">
              <button class="btn-icon" title="Edit"
                (click)="openMarkModal(rec)">âœï¸</button>
              <button class="btn-icon btn-clockout-sm"
                *ngIf="rec.clockIn && !rec.clockOut"
                title="Clock Out"
                (click)="handleClockOut(rec.staffId)">ğŸ”´</button>
              <button class="btn-icon" title="View Details"
                (click)="openDetailModal(rec)">ğŸ‘ï¸</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Monthly Calendar â€” Manager -->
    <div class="calendar-section">
      <h3>{{ calendarMonthLabel }} â€” Overview</h3>
      <div class="calendar-grid">
        <div class="cal-day-label"
          *ngFor="let d of ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']">
          {{ d }}
        </div>
        <div class="cal-offset"
          aria-hidden="true"
          *ngFor="let _ of getOffsetArray()">
        </div>
        <div class="cal-day"
          *ngFor="let day of calendarDays"
          [class.cal-today]="day.date.toDateString() === selectedDate.toDateString()"
          [style.border-color]="day.status ? getAttendanceStatusColor(day.status) : '#e2e8f0'"
          [title]="day.status ? getStatusLabel(day.status) : ''">
          <span class="cal-date">{{ day.date.getDate() }}</span>
          <span class="cal-dot"
            *ngIf="day.status"
            [style.background]="getAttendanceStatusColor(day.status)">
          </span>
        </div>
      </div>
      <div class="calendar-legend">
        <span *ngFor="let s of allStatusValues" class="legend-item">
          <span class="legend-dot" [style.background]="getAttendanceStatusColor(s)"></span>
          {{ getStatusLabel(s) }}
        </span>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Mark Attendance Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="modal-overlay" *ngIf="showMarkModal" (click)="closeMarkModal()">
    <div class="modal-content" (click)="$event.stopPropagation()"
      role="dialog" aria-modal="true" aria-labelledby="markModalTitle">
      <div class="modal-header">
        <h3 id="markModalTitle">âœï¸ Mark Attendance</h3>
        <button class="modal-close" (click)="closeMarkModal()" aria-label="Close">âœ•</button>
      </div>
      <div class="modal-body">

        <div class="form-group">
          <label for="staffSelect">Staff Member</label>
          <select id="staffSelect" [(ngModel)]="markForm.staffId" class="form-control">
            <option value="">â€” Select Staff â€”</option>
            <!-- FIX: Show name + ID instead of raw staffId -->
            <option *ngFor="let rec of records" [value]="rec.staffId">
              {{ rec.staffName }} ({{ rec.staffId }})
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Status</label>
          <div class="status-picker">
            <button
              *ngFor="let s of allStatusValues"
              type="button"
              class="status-pick-btn"
              [class.selected]="markForm.status === s"
              [style.border-color]="getAttendanceStatusColor(s)"
              [style.color]="markForm.status === s ? '#fff' : getAttendanceStatusColor(s)"
              [style.background]="markForm.status === s ? getAttendanceStatusColor(s) : 'transparent'"
              (click)="markForm.status = s">
              {{ getStatusLabel(s) }}
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="markNotes">Notes</label>
          <textarea id="markNotes" class="form-control"
            [(ngModel)]="markForm.notes"
            rows="2"
            placeholder="Optional note...">
          </textarea>
        </div>

      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeMarkModal()">Cancel</button>
        <button class="btn-primary"
          (click)="submitMarkForm()"
          [disabled]="!markForm.staffId">
          âœ… Save
        </button>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="modal-overlay" *ngIf="showDetailModal && selectedRecord" (click)="closeDetailModal()">
    <div class="modal-content detail-modal" (click)="$event.stopPropagation()"
      role="dialog" aria-modal="true" aria-labelledby="detailModalTitle">
      <div class="modal-header">
        <h3 id="detailModalTitle">ğŸ‘ï¸ Attendance Detail</h3>
        <button class="modal-close" (click)="closeDetailModal()" aria-label="Close">âœ•</button>
      </div>

      <div class="modal-body" *ngIf="selectedRecord">
        <div class="detail-row">
          <span class="detail-label">Staff</span>
          <span class="detail-value">
            {{ selectedRecord.staffName }}
            <span class="staff-id">({{ selectedRecord.staffId }})</span>
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Date</span>
          <span class="detail-value">{{ selectedRecord.date | date:'mediumDate' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Status</span>
          <span class="status-badge"
            [style.background]="getAttendanceStatusColor(selectedRecord.status)">
            {{ getStatusLabel(selectedRecord.status) }}
          </span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Clock In</span>
          <span class="detail-value">{{ selectedRecord.clockIn ?? 'â€”' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Clock Out</span>
          <span class="detail-value">{{ selectedRecord.clockOut ?? 'â€”' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Hours</span>
          <span class="detail-value">{{ selectedRecord.totalHours | number:'1.1-2' }}h</span>
        </div>
        <div class="detail-row" *ngIf="selectedRecord.notes">
          <span class="detail-label">Notes</span>
          <span class="detail-value">{{ selectedRecord.notes }}</span>
        </div>
      </div>

      <div class="modal-footer">
        <!-- FIX: single method call prevents flicker from simultaneous open+close -->
        <button class="btn-primary"
          *ngIf="hasManagerAccess"
          (click)="onEditFromDetail()">
          âœï¸ Edit
        </button>
        <button class="btn-clockout"
          *ngIf="selectedRecord?.clockIn && !selectedRecord?.clockOut"
          (click)="handleClockOut(selectedRecord!.staffId); closeDetailModal()">
          ğŸ”´ Clock Out
        </button>
        <button class="btn-secondary" (click)="closeDetailModal()">Close</button>
      </div>
    </div>
  </div>

</div>
