<div class="dashboard-wrapper">

  <!-- ================= SIDEBAR (PRESERVED) ================= -->
  <aside class="sidebar">

    <!-- Occupancy Overview -->
    <div class="sidebar-section">
      <div class="section-header">
        <h3>Occupancy Overview</h3>
      </div>

      <div class="occupancy-stats">
        <div class="stat-row">
          <span class="stat-label"><span class="dot available"></span> Available</span>
          <span class="stat-value">{{ stats.free }}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label"><span class="dot occupied"></span> Occupied</span>
          <span class="stat-value">{{ stats.open }}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label"><span class="dot reserved"></span> Reserved</span>
          <span class="stat-value">{{ stats.hold }}</span>
        </div>
        <div class="stat-row" *ngIf="dirtyCount > 0">
          <span class="stat-label"><span class="dot dirty"></span> Dirty</span>
          <span class="stat-value">{{ dirtyCount }}</span>
        </div>
      </div>

      <div class="current-load">
        <div class="load-header">
          <span>Current Load</span>
          <span>{{ occupancyPercentage }}%</span>
        </div>
        <div class="load-bar-container">
          <div class="load-bar-fill" 
               [style.width.%]="occupancyPercentage"
               [style.background-color]="getOccupancyColor()">
          </div>
        </div>
      </div>
    </div>

    <!-- Upcoming Reservations -->
    <div class="sidebar-section">
      <div class="section-header">
        <h3>Upcoming Reservations</h3>
        <button class="add-res-btn-small" (click)="openAddReservationModal()">+</button>
      </div>

      <div class="reservations-list" *ngIf="upcomingReservations.length > 0">
        <div *ngFor="let res of upcomingReservations; trackBy: trackReservationById" 
             class="reservation-card"
             (click)="markReservationArrived(res)">
          <div class="res-header">
            <span>Table {{ res.tableNumber }}</span>
            <span>{{ res.guests }} Guests</span>
          </div>
          <div class="res-details">
            <div>{{ res.time }} â€¢ {{ res.customerName }}</div>
          </div>
        </div>
      </div>

      <div *ngIf="upcomingReservations.length === 0" class="empty-reservations">
        <p style="font-size: 12px; color: #94a3b8; text-align: center;">No upcoming reservations</p>
      </div>
    </div>

  </aside>

  <!-- ================= MAIN CONTENT ================= -->
  <main class="dashboard-main">

    <!-- âœ¨ ENHANCED HEADER -->
    <header class="dashboard-header">

      <!-- LEFT: Filter Bar -->
      <div class="filter-bar">
        <button class="filter-btn" [class.active]="filter === 'ALL'" (click)="setFilter('ALL')">
          All Tables
        </button>
        <button class="filter-btn" [class.active]="filter === 'available'" (click)="setFilter('available')">
          Available
        </button>
        <button class="filter-btn" [class.active]="filter === 'occupied'" (click)="setFilter('occupied')">
          Occupied
        </button>
      </div>

      <!-- CENTER: Area Tabs -->
      <nav class="area-tabs">
        <button *ngFor="let area of areas"
                class="area-tab"
                [class.active]="selectedArea === area.id"
                (click)="selectArea(area.id)">
          {{ area.label }}
        </button>
        <button class="area-tab btn-manage-areas" (click)="openManageAreasModal()">
          <span>âš™ï¸ Manage</span>
        </button>
      </nav>

      <!-- RIGHT: Actions -->
      <div class="header-actions">
        <button class="btn-action" (click)="toggleEditMode()">
          <span *ngIf="!isEditMode">âœï¸ Edit</span>
          <span *ngIf="isEditMode">âœ… Finish</span>
        </button>
        <button class="btn-action btn-primary" (click)="openAddTableModal()">
          + Add
        </button>
      </div>

    </header>

    <!-- âœ¨ ENHANCED CONTENT AREA -->
    <div class="dashboard-content">

      <!-- Table Grid -->
      <div class="table-grid">

        <div *ngFor="let table of filteredTables; trackBy: trackById" 
             class="table-card"
             [ngClass]="'status-' + table.status"
             [class.priority-card]="table['isPriority']">

          <!-- âœ… NEW: Priority Ribbon (Visual Indicator) -->
          <div *ngIf="table['isPriority']" class="priority-ribbon" title="High Priority">â˜… Priority</div>

          <!-- Card Header -->
          <div class="card-header">
            <div class="table-num">{{ table.id }}</div>
            
            <div style="display: flex; gap: 5px; align-items: center;">
               <div class="status-badge">{{ table.status }}</div>
               
               <!-- âœ… NEW: Priority Toggle Button -->
               <button class="icon-btn priority-btn" 
                       [class.active]="table['isPriority']" 
                       (click)="togglePriority(table, $event)"
                       title="Toggle Priority Status">
                 ğŸš©
               </button>
            </div>
          </div>

          <!-- Edit Mode Remove Button -->
          <button *ngIf="isEditMode" 
                  class="remove-btn-overlay" 
                  (click)="removeTable(table.id, $event)">âœ•</button>

          <!-- Card Body -->
          <div class="card-body">

            <!-- ========== AVAILABLE ========== -->
            <div *ngIf="table.status === 'available'" class="status-content">
              <div class="capacity">
                <span class="icon">ğŸ‘¥</span>
                <span>{{ table.capacity }} Seats</span>
              </div>

              <button class="btn-card-primary visible-action" (click)="startOrder(table, $event)">
                Start Order
              </button>
            </div>

            <!-- ========== OCCUPIED ========== -->
            <div *ngIf="table.status === 'occupied'" class="status-content">

              <!-- Captain Info -->
              <div class="captain-info" (click)="openAssignCaptainModal(table, $event)">
                 <span class="icon">ğŸ›ï¸</span>
                 <span class="name">{{ table.waiter || 'Staff' }}</span>
              </div>

              <!-- Time Elapsed (Highlight red if priority) -->
              <div class="time-info" [class.text-danger]="table['isPriority']">
                 <span class="icon">â±ï¸</span>
                 <span>{{ getTimeElapsed(table.startTime) }}</span>
              </div>

              <!-- Bill Amount -->
              <div class="amount-info">
                 <span class="icon">ğŸ’µ</span>
                 <span class="amount">{{ formatCurrency(table.amount || 0) }}</span>
              </div>

              <!-- Always Visible Actions -->
              <div class="card-actions visible-actions">
                <button class="btn-card-outline" (click)="editTable(table, $event)">Edit</button>
                <button class="btn-card-primary" (click)="checkoutTable(table, $event)">Check out</button>
              </div>
            </div>

            <!-- ========== RESERVED ========== -->
            <div *ngIf="table.status === 'reserved'" class="status-content">
              <div class="guest-name">
                <span class="icon">ğŸ‘¤</span>
                <span>{{ table.reservationDetails?.customerName || 'Reserved' }}</span>
              </div>
              <div class="time">
                <span class="icon">ğŸ•</span>
                <span>{{ table.reservationDetails?.time }}</span>
              </div>

              <button class="btn-card-primary visible-action" (click)="startOrder(table, $event)">
                Arrived
              </button>
            </div>

            <!-- ========== CLEANING ========== -->
            <div *ngIf="table.status === 'cleaning'" class="status-content">
              <div class="cleaning-text">
                <span class="icon">ğŸ§¹</span>
                <span>Needs Cleaning</span>
              </div>

              <button class="btn-card-dark visible-action" (click)="markTableClean(table, $event)">
                Mark Clean
              </button>
            </div>

          </div> <!-- End Card Body -->

        </div> <!-- End Table Card -->

      </div> <!-- End Table Grid -->

    </div> <!-- End Dashboard Content -->

  </main>

</div>

<!-- ================= MODALS (ALL PRESERVED) ================= -->

<!-- Add Table Modal -->
<div class="modal-overlay" *ngIf="showAddTableModal" (click)="closeAddTableModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Add New Table</h2>
      <button class="close-btn" (click)="closeAddTableModal()">âœ•</button>
    </div>

    <div class="form-group">
      <label class="form-label">Capacity (Seats)</label>
      <div class="capacity-options">
        <button *ngFor="let cap of [2, 4, 6, 8]" 
                class="cap-btn" 
                [class.selected]="selectedCapacity === cap"
                (click)="setCapacity(cap)">
          {{ cap }}
        </button>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-action" (click)="closeAddTableModal()">Cancel</button>
      <button class="btn-action btn-primary" (click)="confirmAddTable()">Confirm Add</button>
    </div>
  </div>
</div>

<!-- Manage Floors Modal -->
<div class="modal-overlay" *ngIf="showManageAreasModal" (click)="closeManageAreasModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Manage Floors</h2>
      <button class="close-btn" (click)="closeManageAreasModal()">âœ•</button>
    </div>

    <div class="form-group">
      <label class="form-label">Add New Floor</label>
      <div style="display: flex; gap: 8px;">
        <input type="text" class="form-input" [(ngModel)]="newAreaName" placeholder="e.g. Patio">
        <button class="btn-action btn-primary" (click)="addArea()">Add</button>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Existing Floors</label>
      <div class="floor-list">
        <div *ngFor="let area of areas" class="floor-item">
          <span>{{ area.label }}</span>
          <button *ngIf="area.id !== 'main-hall'" 
                  class="btn-remove-floor" 
                  (click)="removeArea(area.id)"
                  title="Remove Floor">âœ•</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Assign Captain Modal -->
<div class="modal-overlay" *ngIf="showAssignCaptainModal" (click)="closeAssignCaptainModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Select Captain</h2>
      <button class="close-btn" (click)="closeAssignCaptainModal()">âœ•</button>
    </div>

    <div class="form-group">
      <label class="form-label">Assign Waiter / Captain</label>
      <div class="waiter-list">
        <div *ngFor="let waiter of waitersList" 
             class="waiter-option" 
             [class.selected]="selectedCaptain === waiter"
             (click)="selectedCaptain = waiter">
          <span class="waiter-avatar">ğŸ‘¤</span>
          <span class="waiter-name">{{ waiter }}</span>
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-action" (click)="closeAssignCaptainModal()">Cancel</button>
      <button class="btn-action btn-primary" (click)="confirmAssignCaptain()">Assign</button>
    </div>
  </div>
</div>

<!-- Add Reservation Modal -->
<div class="modal-overlay" *ngIf="showAddReservationModal" (click)="closeAddReservationModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">New Reservation</h2>
      <button class="close-btn" (click)="closeAddReservationModal()">âœ•</button>
    </div>

    <div class="form-group">
      <label class="form-label">Customer Name</label>
      <input type="text" class="form-input" [(ngModel)]="newReservation.customerName" placeholder="Enter name">
    </div>

    <div class="form-group">
      <label class="form-label">Guests</label>
      <input type="number" class="form-input" [(ngModel)]="newReservation.guests" placeholder="2">
    </div>

    <div class="form-group">
      <label class="form-label">Time</label>
      <input type="time" class="form-input" [(ngModel)]="newReservation.time">
    </div>

    <div class="modal-actions">
      <button class="btn-action" (click)="closeAddReservationModal()">Cancel</button>
      <button class="btn-action btn-primary" (click)="confirmAddReservation()">Save Reservation</button>
    </div>
  </div>
</div>
